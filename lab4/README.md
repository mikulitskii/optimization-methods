# Лабораторная работа №4

## Цели работы:
- Написать “плохой” CI/CD файл, который работает, но в нем есть не менее пяти “bad practices” по написанию CI/CD
- Написать “хороший” CI/CD, в котором эти плохие практики исправлены
- В Readme описать каждую из плохих практик в плохом файле, почему она плохая и как в хорошем она была исправлена, как исправление повлияло на результат

## Ход работы

### “Плохой” CI/CD файл:

Мы постарались и написали ужасный CI/CD файл содержащий 5 плохих практик. 

```bash
name: bad CI/CD

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: echo "Skipping tests..."

      - name: Build project
        run: npm run build

      - name: Deploy
        run: npm run deploy-prod
``` 
А теперь мы постараемся и исравим его, сделав мир лучше.

### “Хороший” CI/CD файл:

```bash
name: good CI/CD

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Cache Node.js dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Lint check
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Build project
        run: npm run build

  staging:
    needs: build  # Выполняется только после успешного завершения сборки
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to staging
        run: npm run deploy-staging

  deploy:
    needs: staging  # Выполняется только после успешного деплоя на staging
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production
        run: npm run deploy-prod
``` 


### Плохие практики “Плохом” CI/CD файле:

1. Отсутствие указания ветки для запуска - CI/CD срабатывает на любой push, включая временные ветки. Это может приводить к ненужному деплою. В хорошем файле мы указали ветку при push в которую должен срабатывать CI/CD.
2. Деплой выполняется без тестирования результата сборки - Даже если билд или тесты завершились с ошибками, деплой все равно запускается. В хорошей версии файла мы добавили дополнительные jobs, которые будут срабатывать только при успешном срабатывание придыдущей. Для деплоя это build и staging.
3. Весь процесс объединен в один job - Это затрудняет отладку и параллелизацию, так как ошибки приходится искать в единственном месте. В хорошем файле мы разделили pipeline на несколько этапов.
4. Деплой происходит без staging - Код сразу развертывается в production, что рискованно. В хорошей версии файла мы добавили сначала развертывание в среду для тестирования и только в случае успешного развертывания на staging, мы будем развертывать на prod.
5. Зависимости устанавливаются заново при каждом запуске -  Увеличивает время выполнения CI/CD, перегружает систему. В хорошей версии файла мы будем использовать кеширование для node_modules. 
6. Не используется Lint для проверки кода на чистоту - Это необходимо для приведения кода к единообразному стилю. В хорошей версии файла мы добавим использование.
7. Обновление зависимостей с помощью npm install - При таком типе обновления зависимостей мы будем получать не предсказуемую работу системы, потому что используется не стабильная версия зависимости, которая заложена в проекте, а та которая будет свежее на данный момент. В итоге мы получаем потенциальное место для новых багов. В хорошем файле мы будем исользовать npm ci, которая отталкивается package-lock.json и гарантирует строгое соответствие зависимостей.

## Итоги работы:
Научились создавать хорошие CI/CD файлы и стали на шаг ближе к DevOps.